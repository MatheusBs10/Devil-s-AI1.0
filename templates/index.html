<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto Ant√≠tese</title>
    <style>
        /* --- ESTILO GERAL --- */
        :root { --primary: #2c3e50; --accent: #e74c3c; --success: #2ecc71; --bg: #f4f4f9; --text-scale: 1; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); display: flex; height: 100vh; }
        
        .sidebar { width: 80px; background: var(--primary); display: flex; flex-direction: column; align-items: center; padding-top: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 100; }
        .nav-btn { background: none; border: none; color: white; font-size: calc(24px * var(--text-scale)); margin-bottom: 30px; cursor: pointer; opacity: 0.6; transition: 0.3s; position: relative; }
        .nav-btn:hover, .nav-btn.active { opacity: 1; transform: scale(1.1); }

        .content { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- HUD (PAINEL DE GR√ÅFICOS) --- */
        .hud-panel { 
            background: white; padding: 20px; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 25px; 
            display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 20px; /* 3 COLUNAS */
            align-items: center; border-left: 6px solid var(--primary); 
        }

        /* Coluna 1: Feedback & Clareza */
        .hud-left { display: flex; flex-direction: column; justify-content: center; }
        .readability-badge { 
            display: inline-block; padding: 5px 10px; border-radius: 15px; width: fit-content;
            font-size: 11px; font-weight: bold; color: white; background: #3498db; margin-bottom: 8px;
        }
        .feedback-box { font-size: calc(14px * var(--text-scale)); font-weight: 600; color: #555; line-height: 1.4; }
        .feedback-warning { color: #e74c3c; font-weight: 800; }

        /* Coluna 2: Veloc√≠metro (Central) */
        .hud-center { text-align: center; border-left: 1px solid #eee; border-right: 1px solid #eee; padding: 0 10px; }
        .gauge-container { position: relative; width: 180px; height: 90px; overflow: hidden; margin: 0 auto; }
        .gauge-body { 
            width: 180px; height: 180px; border-radius: 50%; 
            background: conic-gradient(from 270deg, #e74c3c 0deg 45deg, #e67e22 45deg 90deg, #f1c40f 90deg 135deg, #2ecc71 135deg 180deg, transparent 180deg);
            position: absolute; top: 0; left: 0;
        }
        .gauge-cover { width: 140px; height: 140px; background: white; border-radius: 50%; position: absolute; top: 20px; left: 20px; }
        .gauge-needle { 
            width: 4px; height: 85px; background: #2c3e50; position: absolute; bottom: 0; left: 50%; margin-left: -2px; 
            transform-origin: bottom center; transform: rotate(-90deg); transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 5px 5px 0 0; z-index: 10; 
        }
        .gauge-dot { width: 14px; height: 14px; background: #2c3e50; border-radius: 50%; position: absolute; bottom: -7px; left: 50%; margin-left: -7px; z-index: 11; }
        
        /* Rodap√© do Gauge (Nota e Legendas) */
        .gauge-footer { 
            display: flex; justify-content: space-between; align-items: center; 
            width: 200px; margin: 10px auto 0; 
        }
        .label-text { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #888; width: 60px; }
        .score-display { font-size: 24px; font-weight: 800; color: var(--primary); margin: 0 10px; }

        /* Coluna 3: Subjetividade (Direita) */
        .hud-right { padding-left: 10px; }
        .sub-label { font-size: 12px; color: #666; font-weight: bold; display: block; margin-bottom: 5px; }
        .sub-bar-container { width: 100%; height: 12px; background: #eee; border-radius: 6px; position: relative; margin-bottom: 5px; overflow: hidden; }
        .sub-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #3498db 0%, #9b59b6 100%); }
        .sub-marker { position: absolute; top: -2px; left: 50%; width: 4px; height: 16px; background: #333; border: 1px solid white; transition: left 0.8s; }
        .sub-legend { display: flex; justify-content: space-between; font-size: 9px; color: #888; text-transform: uppercase; font-weight: bold; }

        /* --- HOME --- */
        .setup-card { background: white; padding: 50px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); max-width: 700px; margin: 20px auto; text-align: center; }
        .setup-card h1 { color: var(--primary); font-size: calc(32px * var(--text-scale)); margin-bottom: 10px; }
        .setup-card p { color: #666; font-size: calc(16px * var(--text-scale)); margin-bottom: 30px; }
        .setup-input { width: 80%; padding: 15px; font-size: calc(18px * var(--text-scale)); border: 2px solid #eee; border-radius: 10px; margin-bottom: 20px; outline: none; text-align: center; transition: 0.3s; }
        .setup-input:focus { border-color: var(--primary); }
        .topic-chips { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 30px; }
        .chip { background: #f0f2f5; padding: 10px 20px; border-radius: 25px; font-size: calc(14px * var(--text-scale)); cursor: pointer; transition: 0.2s; color: #555; font-weight: 500; }
        .chip:hover { background: #e2e6ea; transform: translateY(-2px); }
        #btn-start { background: var(--primary); color: white; padding: 15px 40px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }

        /* --- CHAT --- */
        .chat-container { background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; height: 55vh; border: 1px solid #eee; }
        .chat-box { flex: 1; padding: 30px; overflow-y: scroll; display: flex; flex-direction: column; gap: 15px; background: #fafafa; }
        .msg { max-width: 75%; padding: 12px 18px; border-radius: 18px; font-size: calc(15px * var(--text-scale)); line-height: 1.5; animation: popIn 0.3s ease-out; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .msg.model, .msg.ia { background: #fff; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #e0e0e0; color: #333; }
        .msg.ia::before, .msg.model::before { content: 'ü§ñ Ant√≠tese'; position: absolute; top: -20px; left: 5px; font-size: 11px; color: #999; font-weight: bold; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg.sys { align-self: center; background: #e9ecef; color: #666; font-size: 12px; padding: 5px 15px; border-radius: 20px; font-style: italic; }
        .input-area { padding: 20px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 15px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; outline: none; }
        input[type="text"]:focus { border-color: var(--primary); }
        #btn-send { padding: 0 25px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* Tabelas, Configs, Modais */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .history-table th { background: #f8f9fa; padding: 15px; text-align: left; color: #555; font-weight: 700; border-bottom: 2px solid #eee; }
        .history-table td { padding: 15px; border-bottom: 1px solid #eee; color: #444; }
        .badge { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .badge-win { background: #d4edda; color: #155724; }
        .badge-loss { background: #f8d7da; color: #721c24; }
        .toggle-btn { background: #eee; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; margin-left: 8px; font-weight: 600; }
        .toggle-btn.active { background: var(--primary); color: white; }
        .btn-small { padding: 6px 12px; font-size: 12px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 4px; }
        .config-card { background: white; padding: 30px; border-radius: 15px; max-width: 600px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .config-label { font-weight: bold; color: var(--primary); display: block; margin-bottom: 10px; }
        .api-input-group { display: flex; gap: 10px; align-items: stretch; }
        .api-input-group input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
        .api-input-group button { padding: 0 25px; border: none; background: var(--primary); color: white; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .lang-btn { flex: 1; padding: 10px; cursor: pointer; border: 1px solid #ddd; background: #f8f9fa; font-weight: bold; border-radius: 6px; color: #555; }
        .lang-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-content { background: white; width: 90%; max-width: 700px; height: 80%; border-radius: 15px; padding: 30px; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .replay-box { flex: 1; overflow-y: auto; background: #fafafa; border: 1px solid #eee; padding: 20px; border-radius: 10px; display: flex; flex-direction: column; gap: 12px; }
        .feedback-popup { position: fixed; bottom: 30px; right: 30px; width: 320px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 25px; z-index: 2000; display: none; border: 1px solid #e0e0e0; }
        .feedback-step { display: none; } .feedback-step.active { display: block; }
        .star-container { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .star-btn { font-size: 28px; cursor: pointer; background: none; border: none; color: #ccc; } .star-btn.selected { color: #f1c40f; }
        .fb-textarea { width: 100%; padding: 12px; border: 1px solid #ccc; background: #fff; border-radius: 8px; resize: none; margin-bottom: 15px; box-sizing: border-box; }
        .fb-btn { background: var(--primary); color: white; width: 100%; padding: 10px; border-radius: 8px; margin-top: 10px; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div class="sidebar">
        <button class="nav-btn active" onclick="showTab('tab-home')" title="Home">üè†</button>
        <button class="nav-btn" onclick="showTab('tab-history')" title="Hist√≥rico">üìú</button>
        <button class="nav-btn" onclick="showTab('tab-config')" title="Configura√ß√µes">‚öôÔ∏è</button>
    </div>

    <!-- HOME -->
    <div id="tab-home" class="content active">
        <h2 style="color: var(--primary); margin-top: 0; font-size: calc(24px * var(--text-scale));" data-i18n="arena_title">üî• Arena de Debate</h2>
        
        <!-- HUD COM 3 COLUNAS -->
        <div id="hud-area" class="hud-panel" style="display: none;">
            <!-- 1. Feedback e Clareza -->
            <div class="hud-left">
                <div class="readability-badge" id="clarity-badge">Clareza: -</div>
                <div id="txt-feedback" class="feedback-box">Aguardando in√≠cio...</div>
            </div>
            
            <!-- 2. Gauge (Veloc√≠metro) -->
            <div class="hud-center">
                <div class="gauge-container">
                    <div class="gauge-body"><div class="gauge-cover"></div><div class="gauge-needle" id="gauge-needle"></div><div class="gauge-dot"></div></div>
                </div>
                <div class="gauge-footer">
                    <span class="label-text" style="color: #e74c3c; text-align:left;" data-i18n="doubt_label">RISCO</span>
                    <div class="score-display" id="score-val">50</div>
                    <span class="label-text" style="color: #2ecc71; text-align:right;" data-i18n="domain_label">SEGURAN√áA</span>
                </div>
            </div>

            <!-- 3. Subjetividade -->
            <div class="hud-right">
                <span class="sub-label" data-i18n="subjectivity_label">Fatos vs Opini√£o</span>
                <div class="sub-bar-container">
                    <div class="sub-bar-fill"></div>
                    <div class="sub-marker" id="sub-marker" style="left: 50%;"></div>
                </div>
                <div class="sub-legend"><span>Fatos</span><span>Opini√£o</span></div>
            </div>
        </div>

        <div id="setup-area" class="setup-card">
            <h1 data-i18n="challenge_title">Desafie a IA</h1>
            <p data-i18n="challenge_desc">Escolha qualquer assunto. A IA vai "pesquisar" e criar uma tese falsa para voc√™ derrubar.</p>
            <input type="text" id="tema-input" class="setup-input" placeholder="Ex: Aquecimento Global..." onkeypress="handleSetupEnter(event)">
            <div class="topic-chips" id="topic-chips-container"></div>
            <button onclick="iniciarDebate()" id="btn-start" data-i18n="start_btn">INICIAR DEBATE</button>
        </div>

        <div id="debate-area" style="display: none;">
            <div class="chat-container">
                <div id="chat-box" class="chat-box"></div>
                <div class="input-area">
                    <input type="text" id="user-input" placeholder="Refute a IA..." onkeypress="handleChatEnter(event)">
                    <button id="btn-send" onclick="enviarMensagem()" data-i18n="send_btn">Enviar</button>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="encerrarDebate()" style="background: #e74c3c; padding: 12px 30px; border-radius:8px; color:white; border:none; cursor:pointer;" data-i18n="end_btn">Encerrar Debate</button>
            </div>
        </div>
    </div>

    <!-- HIST√ìRICO -->
    <div id="tab-history" class="content">
        <h2 style="font-size: calc(24px * var(--text-scale));">
            <span data-i18n="data_title">üìú Hist√≥rico</span> 
            <button id="btn-toggle-debates" class="toggle-btn active" onclick="switchHistoryMode('debates')" data-i18n="btn_battles">Debates</button>
            <button id="btn-toggle-feedbacks" class="toggle-btn" onclick="switchHistoryMode('feedbacks')" data-i18n="btn_reviews">Avalia√ß√µes</button>
        </h2>
        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
                <button onclick="carregarHistorico()" class="btn-small" data-i18n="refresh_btn">üîÑ Atualizar</button>
            </div>
            <table class="history-table"><thead id="history-header"></thead><tbody id="history-table-body"><tr><td colspan="5" style="text-align: center;">...</td></tr></tbody></table>
        </div>
    </div>

    <!-- CONFIGS -->
    <div id="tab-config" class="content">
        <h2 style="font-size: calc(24px * var(--text-scale));" data-i18n="config_title">‚öôÔ∏è Configura√ß√µes</h2>
        <div class="config-card"><label class="config-label">Google Gemini API Key:</label><div class="api-input-group"><input type="password" id="api-key-input" placeholder="Cole sua chave..."><button onclick="salvarKey()" data-i18n="save_btn">Salvar</button></div><p style="font-size: 12px; color: #777; margin-top: 10px;" data-i18n="api_help">Salva apenas na sess√£o.</p></div>
        <div class="config-card"><label class="config-label" data-i18n="access_title">Acessibilidade:</label><div style="display: flex; gap: 10px; margin: 10px 0;"><button onclick="mudarFonte(0.85)" style="flex:1;background:#95a5a6;border:none;color:white;padding:10px;border-radius:5px;cursor:pointer">A-</button><button onclick="mudarFonte(1)" style="flex:1;background:var(--primary);border:none;color:white;padding:10px;border-radius:5px;cursor:pointer">A</button><button onclick="mudarFonte(1.25)" style="flex:1;background:var(--primary);border:none;color:white;padding:10px;border-radius:5px;cursor:pointer">A+</button></div><p style="text-align:center;color:#999;"><span data-i18n="size_current_label">Tamanho:</span> <span id="font-display">Normal</span></p></div>
        <div class="config-card"><label class="config-label" data-i18n="lang_title">Idioma / Language:</label><div style="display: flex; gap: 10px;"><button class="lang-btn active" id="btn-pt" onclick="mudarIdioma('pt')">üáßüá∑ Portugu√™s</button><button class="lang-btn" id="btn-en" onclick="mudarIdioma('en')">üá∫üá∏ English</button></div></div>
    </div>

    <!-- POPUPS -->
    <div id="feedback-popup" class="feedback-popup">
        <div id="step-1" class="feedback-step active"><div class="fb-title" data-i18n="fb_q1_title">O que achou da IA?</div><div class="star-container" id="stars-1"><button class="star-btn" onclick="rate(1,1)">‚òÖ</button><button class="star-btn" onclick="rate(1,2)">‚òÖ</button><button class="star-btn" onclick="rate(1,3)">‚òÖ</button><button class="star-btn" onclick="rate(1,4)">‚òÖ</button><button class="star-btn" onclick="rate(1,5)">‚òÖ</button></div><button class="fb-btn" onclick="nextStep(2)" data-i18n="continue_btn">Continuar</button></div>
        <div id="step-2" class="feedback-step"><div class="fb-title" data-i18n="fb_q2_title">Visual</div><div class="star-container" id="stars-2"><button class="star-btn" onclick="rate(2,1)">‚òÖ</button><button class="star-btn" onclick="rate(2,2)">‚òÖ</button><button class="star-btn" onclick="rate(2,3)">‚òÖ</button><button class="star-btn" onclick="rate(2,4)">‚òÖ</button><button class="star-btn" onclick="rate(2,5)">‚òÖ</button></div><button class="fb-btn" onclick="nextStep(3)" data-i18n="continue_btn">Continuar</button></div>
        <div id="step-3" class="feedback-step"><div class="fb-title" data-i18n="fb_q3_title">Sugest√µes?</div><textarea id="fb-text" class="fb-textarea" rows="4"></textarea><button class="fb-btn" onclick="enviarAvaliacao()" data-i18n="finish_btn">Enviar</button></div>
    </div>
    <div id="replay-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3 data-i18n="replay_title">Replay</h3><button onclick="fecharReplay()" style="background:none;border:none;font-size:24px;cursor:pointer">‚úñ</button></div><div id="replay-chat-box" class="replay-box"></div></div></div>

    <script>
        const API_BASE = (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') ? '' : 'http://127.0.0.1:5000';
        let currentScore = 50; let currentLang = 'pt';
        const translations = {
            pt: { arena_title: "üî• Arena de Debate", judge_analysis: "An√°lise do Juiz", ia_label: "IA (Mentira)", user_label: "VOC√ä (Verdade)", challenge_title: "Desafie a IA", challenge_desc: "Escolha um assunto. A IA defender√° uma tese falsa.", start_btn: "INICIAR DEBATE", send_btn: "Enviar", end_btn: "Encerrar Debate", data_title: "üìú Hist√≥rico", btn_battles: "Debates", btn_reviews: "Avalia√ß√µes", refresh_btn: "üîÑ Atualizar", config_title: "‚öôÔ∏è Configura√ß√µes", save_btn: "Salvar", api_help: "Chave salva apenas na sess√£o.", access_title: "Acessibilidade:", access_desc: "Ajuste o tamanho do texto.", lang_title: "Idioma / Language:", fb_q1_title: "O que achou da IA?", fb_q2_title: "Visual", fb_q3_title: "Sugest√µes?", continue_btn: "Continuar", finish_btn: "Enviar", replay_title: "üì¢ Replay", table_header_debates: "<tr><th>Data</th><th>Tema</th><th>Pontua√ß√£o</th><th>Resultado</th><th>A√ß√£o</th></tr>", table_header_reviews: "<tr><th>Data</th><th>IA</th><th>Visual</th><th>Sugest√£o</th></tr>", no_debates: "Ainda n√£o existem debates.", no_reviews: "Ainda n√£o existem avalia√ß√µes.", error_loading: "Erro na conex√£o.", size_current_label: "Tamanho atual:", size_small: "Pequeno", size_normal: "Normal", size_large: "Grande", view_btn: "Ver", user_cell: "Usu√°rio", ia_cell: "IA", doubt_label: "RISCO", domain_label: "SEGURAN√áA", subjectivity_label: "Fatos vs Opini√£o" },
            en: { arena_title: "üî• Debate Arena", judge_analysis: "Judge Analysis", ia_label: "AI (Lie)", user_label: "YOU (Truth)", challenge_title: "Challenge the AI", challenge_desc: "Pick a topic. AI will defend a false thesis.", start_btn: "START DEBATE", send_btn: "Send", end_btn: "End Debate", data_title: "üìú History", btn_battles: "Debates", btn_reviews: "Reviews", refresh_btn: "üîÑ Refresh", config_title: "‚öôÔ∏è Settings", save_btn: "Save", api_help: "Key saved in session only.", access_title: "Accessibility:", access_desc: "Adjust text size.", lang_title: "Language / Idioma:", fb_q1_title: "How was the AI?", fb_q2_title: "Visuals", fb_q3_title: "Suggestions?", continue_btn: "Continue", finish_btn: "Send", replay_title: "üì¢ Replay", table_header_debates: "<tr><th>Date</th><th>Topic</th><th>Score</th><th>Result</th><th>Action</th></tr>", table_header_reviews: "<tr><th>Date</th><th>AI</th><th>Visual</th><th>Suggestion</th></tr>", no_debates: "No debates yet.", no_reviews: "No reviews yet.", error_loading: "Connection error.", size_current_label: "Current size:", size_small: "Small", size_normal: "Normal", size_large: "Large", view_btn: "View", user_cell: "User", ia_cell: "AI", doubt_label: "RISK", domain_label: "SAFETY", subjectivity_label: "Fact vs Opinion" }
        };
        const topics = { pt: [{text:"üåç Terra Plana",val:"A Terra √© Plana"},{text:"üíâ Vacinas",val:"Vacinas s√£o perigosas"}], en: [{text:"üåç Flat Earth",val:"Flat Earth"},{text:"üíâ Vaccines",val:"Vaccines"}] };

        function renderTopics(lang) { const c = document.getElementById('topic-chips-container'); if(c) c.innerHTML = topics[lang].map(t => `<div class="chip" onclick="setTema('${t.val}')">${t.text}</div>`).join(''); }
        function mudarIdioma(l) { currentLang = l; document.getElementById('btn-pt').classList.toggle('active', l === 'pt'); document.getElementById('btn-en').classList.toggle('active', l === 'en'); document.querySelectorAll('[data-i18n]').forEach(el => { const k = el.getAttribute('data-i18n'); if(translations[l][k]) el.innerHTML = translations[l][k]; }); const kIn = document.getElementById('api-key-input'); if(kIn) kIn.placeholder = l === 'pt' ? "Cole sua chave..." : "Paste your key..."; updateSizeLabel(); renderTopics(l); if(document.getElementById('tab-history').classList.contains('active')) switchHistoryMode(currentHistoryMode); }
        function mudarFonte(s) { document.documentElement.style.setProperty('--text-scale', s); localStorage.setItem('antitese_font_scale', s); updateSizeLabel(); }
        function updateSizeLabel() { const s = parseFloat(localStorage.getItem('antitese_font_scale') || 1); let k = s < 1 ? "size_small" : (s > 1 ? "size_large" : "size_normal"); document.getElementById('font-display').innerText = translations[currentLang][k]; }
        window.onload = function() { const s = localStorage.getItem('antitese_font_scale'); if(s) mudarFonte(parseFloat(s)); renderTopics('pt'); switchHistoryMode('debates'); };
        function showTab(id) { document.querySelectorAll('.content').forEach(c => c.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id === 'tab-history') switchHistoryMode(currentHistoryMode); }
        function setTema(t) { document.getElementById('tema-input').value = t; }
        function handleSetupEnter(e) { if(e.key === 'Enter') iniciarDebate(); }
        function handleChatEnter(e) { if(e.key === 'Enter') enviarMensagem(); }

        function atualizarHUD(score, feedback, subj, clarity) {
            const needle = document.getElementById('gauge-needle');
            const scoreVal = document.getElementById('score-val');
            const deg = (score / 100 * 180) - 90;
            if(needle) needle.style.transform = `rotate(${deg}deg)`;
            if(scoreVal) scoreVal.innerText = score;
            const subMarker = document.getElementById('sub-marker');
            if(subMarker && subj !== undefined) subMarker.style.left = `${subj}%`;
            const clBadge = document.getElementById('clarity-badge');
            if(clBadge && clarity !== undefined) { let clText = clarity > 70 ? (currentLang==='pt'?'Alta':'High') : (clarity > 40 ? (currentLang==='pt'?'M√©dia':'Medium') : 'Baixa'); clBadge.innerText = (currentLang==='pt'?'Clareza: ':'Clarity: ') + clText; clBadge.style.background = clarity > 70 ? '#2ecc71' : (clarity > 40 ? '#f1c40f' : '#e74c3c'); }
            const fb = document.getElementById('txt-feedback');
            if(fb) { fb.innerText = feedback; if(subj > 70) { fb.classList.add('feedback-warning'); fb.innerText = (currentLang==='pt'?"ALERTA: Muito subjetivo! ":"ALERT: Too subjective! ") + feedback; } else fb.classList.remove('feedback-warning'); }
        }

        async function enviarMensagem(force = false) {
            const input = document.getElementById('user-input'); const texto = input.value; if(!texto && !force) return;
            if (!force) { addMsg('Voc√™', texto, 'user'); input.value = ''; input.disabled = true; document.getElementById('btn-send').disabled = true; }
            const loadingId = addMsg('Juiz', '...', 'sys');
            try {
                const res = await fetch(`${API_BASE}/responder`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ mensagem: texto, force_continue: force }) });
                const data = await res.json();
                document.getElementById(loadingId).remove();
                if (data.status === 'warning_fuga') { if (confirm("Fuga detectada. Continuar?")) enviarMensagem(true); else encerrarDebate(); }
                else if(data.error) addMsg('Erro', data.error, 'sys');
                else { addMsg('IA', data.mensagem, 'ia'); currentScore = data.score; atualizarHUD(data.score, data.feedback, data.subjectivity, data.clarity); }
            } catch(e) { document.getElementById(loadingId).innerText = "Erro."; }
            input.disabled = false; document.getElementById('btn-send').disabled = false; if (!force) input.focus();
        }

        async function iniciarDebate() {
            const tema = document.getElementById('tema-input').value; if(!tema) return alert("Digite um tema");
            document.getElementById('setup-area').style.display = 'none'; document.getElementById('debate-area').style.display = 'block'; document.getElementById('hud-area').style.display = 'grid'; document.getElementById('chat-box').innerHTML = '';
            addMsg('Sistema', '...', 'sys');
            const res = await fetch(`${API_BASE}/iniciar_debate`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ tema, lang: currentLang }) });
            const data = await res.json();
            document.getElementById('chat-box').innerHTML = '';
            if(data.error) alert(data.error); else { addMsg('IA', data.mensagem, 'ia'); atualizarHUD(50, data.feedback, 50, 100); }
        }

        async function encerrarDebate() { await fetch(`${API_BASE}/finalizar_manual`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ score: currentScore }) }); document.getElementById('feedback-popup').style.display = 'block'; }
        let currentHistoryMode = 'debates';
        function switchHistoryMode(mode) { currentHistoryMode = mode; document.getElementById('btn-toggle-debates').className = mode === 'debates' ? 'toggle-btn active' : 'toggle-btn'; document.getElementById('btn-toggle-feedbacks').className = mode === 'feedbacks' ? 'toggle-btn active' : 'toggle-btn'; const header = document.getElementById('history-header'); if (mode === 'debates') header.innerHTML = translations[currentLang].table_header_debates; else header.innerHTML = translations[currentLang].table_header_reviews; carregarHistorico(); }
        async function carregarHistorico() { const tbody = document.getElementById('history-table-body'); tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">...</td></tr>'; try { const endpoint = currentHistoryMode === 'debates' ? '/get_historico' : '/get_avaliacoes'; const res = await fetch(`${API_BASE}${endpoint}`); if (!res.ok) throw new Error(); const dados = await res.json(); tbody.innerHTML = ''; if(!dados || dados.length === 0) { const msgKey = currentHistoryMode === 'debates' ? 'no_debates' : 'no_reviews'; tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;color:#777;">${translations[currentLang][msgKey]}</td></tr>`; return; } dados.forEach(d => { const tr = document.createElement('tr'); if (currentHistoryMode === 'debates') { let quemVenceu = d.vencedor; if(quemVenceu === 'Aluno') quemVenceu = translations[currentLang].user_cell; else quemVenceu = translations[currentLang].ia_cell; const badgeClass = d.vencedor === 'Aluno' ? 'badge-win' : 'badge-loss'; const viewTxt = translations[currentLang].view_btn; tr.innerHTML = `<td>${d.data}</td><td style="font-weight: 500;">${d.tema}</td><td>${d.score_final}/100</td><td><span class="badge ${badgeClass}">${quemVenceu}</span></td><td><button class="btn-small" onclick="abrirReplay('${d.id}')">${viewTxt}</button></td>`; } else { let sug = d.sugestao; if(!sug || sug === "null" || sug.trim() === "") sug = "-"; tr.innerHTML = `<td>${d.data}</td><td>‚≠ê${d.nota_debate}</td><td>‚≠ê${d.nota_elementos}</td><td colspan="2" style="font-size:13px; font-style:italic">"${sug}"</td>`; } tbody.appendChild(tr); }); } catch(e) { tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">${translations[currentLang].error_loading}</td></tr>`; } }
        async function abrirReplay(id) { try { const res = await fetch(`${API_BASE}/get_detalhes_debate/${id}`); const logs = await res.json(); const box = document.getElementById('replay-chat-box'); box.innerHTML = ''; if(!logs || logs.length === 0) box.innerHTML = '<div style="padding:20px;text-align:center">Nenhum log.</div>'; else { logs.forEach(l => { const tipo = l.role === 'model' ? 'ia' : (l.role === 'user' ? 'user' : 'sys'); if(l.role === 'system') return; const div = document.createElement('div'); div.className = `msg ${tipo}`; div.innerHTML = l.text; box.appendChild(div); }); } document.getElementById('replay-modal').style.display = 'flex'; } catch(e) { alert('Erro ao abrir replay'); } }
        function fecharReplay() { document.getElementById('replay-modal').style.display = 'none'; }
        function rate(step, value) { feedbackData.nota_debate = value; }
        function nextStep(step) { document.querySelectorAll('.feedback-step').forEach(el => el.classList.remove('active')); document.getElementById('step-' + step).classList.add('active'); }
        async function enviarAvaliacao() { feedbackData.sugestao = document.getElementById('fb-text').value; await fetch(`${API_BASE}/salvar_avaliacao`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(feedbackData) }); document.getElementById('feedback-popup').style.display = 'none'; location.reload(); }
        function addMsg(nome, texto, tipo) { const chat = document.getElementById('chat-box'); const div = document.createElement('div'); div.className = `msg ${tipo}`; const t = texto.replace(/\n/g, '<br>'); if(tipo === 'sys') div.innerHTML = `<small>${t}</small>`; else div.innerHTML = `<strong>${nome}:</strong> ${t}`; chat.appendChild(div); chat.scrollTop = chat.scrollHeight; return div.id = 'msg-' + Date.now(); }
        function exibirPopup(msg, tipo) { alert(msg); }
        async function salvarKey() { const key = document.getElementById('api-key-input').value; await fetch(`${API_BASE}/set_api_key`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ api_key: key }) }); alert('Salvo!'); }
    </script>
</body>
</html>